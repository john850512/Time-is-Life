<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service (complex)</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 80%;
		padding-top: 10px;
      }
      #warnings-panel {
        width: 100%;
        height:10%;
        text-align: center;
      }
	  #floating-panel {
	    position: absolute;
	    top: 10px;
 	    left: 40%;
 	    z-index: 5;
 	    background-color: #fff;
 	    padding: 5px;
  	    border: 1px solid #999;
 	    text-align: center;
 	    font-family: 'Roboto','sans-serif';
  	    line-height: 30px;
 	    padding-left: 10px;
	  }

    </style>
  </head>
  <body>
    <div id="floating-panel">
    <b>Start: </b>
    <select id="start">
      <option value="高雄大學">高雄大學</option>
    </select>
    <b>End: </b>
    <select id="end">
      <option value="楠梓加工區">楠梓加工區</option>
      <option value="捷運油廠國小站">捷運油廠國小站</option>
      <option value="楠梓家樂福">楠梓家樂福</option>
	  <option value="台北火車站">台北火車站</option>
	  <option value="高雄火車站">高雄火車站</option>
	  <option value="義守大學">義守大學</option>
	  <option value="台中火車站">台中火車站</option>
	  <option value="屏東火車站">屏東火車站</option>
    </select>
    </div>
    <div id="map"></div>
    &nbsp;
    <div id="warnings-panel"></div>
    <script>
    
    //google map api for initial map 
    var markerArray,directionsService,map,directionsDisplay,stepDisplay;
    //websocket
    var webSocket = new WebSocket('ws://192.168.1.143:8080/WebSocket/websocket');
    //navigation request
	var navID = 1;
	var originPos = "高雄大學";
	var destinationPos = "楠梓家樂福";
	
    webSocket.onerror = function(event) {
        onError(event)
    };

    webSocket.onopen = function(event) {
        onOpen(event)
    };

    webSocket.onmessage = function(event) {
        onMessage(event)
    };

    function onMessage(event) {
		var navID = Integer.valueOf(event.data.split("$")[1]);
		var originPos = message.split("$")[2].split(" ")[0];
		var destinationPos = message.split("$")[2].split(" ")[1];
	    calculateAndDisplayRoute(
	    		directionsDisplay, directionsService, markerArray, stepDisplay, map);
    }

    function onOpen(event) {
        webSocket.send('[web]onOpen');
    }

    function onError(event) {
        alert(event.data);
    }

    function start() {
        //webSocket.send('hello');
        return false;
    }
    
    //----------------------------------------------------------------------
	
	function initMap() {
	  markerArray = [];
	
	  // Instantiate a directions service.
	  directionsService = new google.maps.DirectionsService;
	
	  // Create a map and center it on Manhattan.
	  map = new google.maps.Map(document.getElementById('map'), {
	    zoom: 13,
	    center: {lat: 22.7344154, lng: 120.2829894}//高雄大學
	  });
	
	  // Create a renderer for directions and bind it to the map.
	  directionsDisplay = new google.maps.DirectionsRenderer({map: map});
	
	  // Instantiate an info window to hold step text.
	  stepDisplay = new google.maps.InfoWindow;
	
	  // Display the route between the initial start and end selections.
	  /*
	  calculateAndDisplayRoute(
	      directionsDisplay, directionsService, markerArray, stepDisplay, map);
	  */
	  // Listen to change events from the start and end lists.
	  var onChangeHandler = function() {
	    calculateAndDisplayRoute(
	        directionsDisplay, directionsService, markerArray, stepDisplay, map);
	  };
	  document.getElementById('start').addEventListener('change', onChangeHandler);
	  document.getElementById('end').addEventListener('change', onChangeHandler);
	}
	
	function calculateAndDisplayRoute(directionsDisplay, directionsService,
	    markerArray, stepDisplay, map) {
	  // First, remove any existing markers from the map.
	  for (var i = 0; i < markerArray.length; i++) {
		if(i % 2 == 0)continue;//更改同時也要改showSteps裡的marker設定
	    markerArray[i].setMap(null);
	  }
	
	  // Retrieve the start and end locations and create a DirectionsRequest using
	  // WALKING directions.
	  // 用走路的模式偵測
	  // 用汽車會一直有微靠左行這種指令 點會變多
	  directionsService.route({
	    origin: document.getElementById('start').value,
	    destination: document.getElementById('end').value,
	    //origin: originPos,
	    //destination: destinationPos,
	    travelMode: google.maps.TravelMode.DRIVING
	    
	    
	    
	  }, function(response, status) {
	    // Route the directions and pass the response to a function to create
	    // markers for each step.
	    if (status === google.maps.DirectionsStatus.OK) {
	      document.getElementById('warnings-panel').innerHTML =
	          '<b>' + response.routes[0].warnings + '</b></br>';
	      directionsDisplay.setDirections(response);
	      showSteps(response, markerArray, stepDisplay, map);
		  
	    } else {
	      window.alert('Directions request failed due to ' + status);
	    }
	  });
	}
	
	function showSteps(directionResult, markerArray, stepDisplay, map) {
	  // For each step, place a marker, and add the text to the marker's infowindow.
	  // Also attach the marker to an array so we can keep track of it and remove it
	  // when calculating new routes.
	   // routes[]是查詢的路徑結果
	  // 除非provideRouteAlternatives 是true不然routes[]基本上只會有一條結果 
	  // 在導航指令更新的時候會有新的Steps點
	  // 每一個legs包含一連串的steps
	
	  var myRoute = directionResult.routes[0].legs[0];
	  var i = 0;
	  var tempPostString = "[web]gma"+"$"+navID+"$";
	  //一點點
	/*  
	  for (i = 0; i < myRoute.steps.length; i++) {
	    var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
	    marker.setMap(map);
	    marker.setPosition(myRoute.steps[i].start_location);
		var marker1 = markerArray[i] = markerArray[i] || new google.maps.Marker;
		marker.setMap(map);
		//add latlng into tempPostString
		tempPostString +=i+': '+myRoute.steps[0].start_location.lat()+' '+myRoute.steps[0].start_location.lng()+'\n';
		//取得資訊
		document.getElementById('warnings-panel').innerHTML +=myRoute.steps[i].start_location + "</br>";
	    attachInstructionText(
	        stepDisplay, marker, myRoute.steps[i].instructions, map);
	  }
	  //post to php
	  post_to_url('test.php', {"0":tempPostString});
	*/  
	  
	  //很多點
	  //取得單一經緯度.lat() .lng()
		var flag = false;//第一筆不要空格
	    for (i = 0; i < directionResult.routes[0].overview_path.length  ; i++) {
	    	if(i % 2 == 0)continue;//更改同時也要改calculateAndDisplayRoute裡面的初始化
			var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
			marker.setMap(map);
			marker.setPosition(directionResult.routes[0].overview_path[i]);
			
			//取得資訊
			document.getElementById('warnings-panel').innerHTML +=directionResult.routes[0].overview_path[i] +"0."+i + " " +"1."+directionResult.routes[0].overview_path.length+"</br>";
			if(flag){
				tempPostString += ' ';
				
			}
			tempPostString +=directionResult.routes[0].overview_path[i].lng()+','+directionResult.routes[0].overview_path[i].lat();
			flag = true;
	    } 
	    
		//post_to_url('test.php', {"0":tempPostString});
		//post_to_url("http://localhost:5580", {"0":tempPostString});
	    webSocket.send(tempPostString);
	    navID++;
	    //return false;
	}
	
	function attachInstructionText(stepDisplay, marker, text, map) {
	  google.maps.event.addListener(marker, 'click', function() {
	    // Open an info window when the marker is clicked on, containing the text
	    // of the step.
	    stepDisplay.setContent(text);
	    stepDisplay.open(map, marker);
	  });
	}
	function post_to_url(path, params, method) {
	    method = method || "post"; // Set method to post by default, if not specified.
	    // The rest of this code assumes you are not using a library.
	    // It can be made less wordy if you use one.
	    var form = document.createElement("form");
	    form.setAttribute("method", method);
	    form.setAttribute("action", path);
	
	    var hiddenField = document.createElement("input");
	    hiddenField.setAttribute("type", "hidden");
	    hiddenField.setAttribute("name", "info");
	    hiddenField.setAttribute("value", "info");	
		form.appendChild(hiddenField);
		
	    for(var key in params) {
	        var hiddenField = document.createElement("input");
	        hiddenField.setAttribute("type", "hidden");
	        hiddenField.setAttribute("name", key);
	        hiddenField.setAttribute("value", params[key]);
	
	        form.appendChild(hiddenField);
	    }
	
	    document.body.appendChild(form);    // Not entirely sure if this is necessary
	    form.submit();
	}
	

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBuLxs9L5DAbvCWRpMVWAk7VpBZ7OuSO1Q&signed_in=true&callback=initMap"
        async defer></script>
  </body>
</html>